<!--system.html - VERSION CORRIG√âE POUR LA PERSISTENCE-->
<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classification Tarifaire CEDEAO - TEC SH 2022 - IA Avanc√©e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'douane-vert': '#1B5E20',
                    'douane-or': '#FFD700',
                    'douane-blanc': '#FFFFFF',
                    'orange-ci': '#FF8C00',
                    'vert-ci': '#00B04F',
                    'lion-or': '#B8860B'
                }
            }
        }
    }
    </script>
    
    <!-- ‚úÖ V√âRIFICATION D'AUTHENTIFICATION CORRIG√âE -->
    <script>
        (function() {
            console.log('üîê V√©rification de l\'authentification...');
            
            try {
                const currentUser = localStorage.getItem('current_user');
                const sessionToken = localStorage.getItem('session_token');
                
                console.log('currentUser dans localStorage:', !!currentUser);
                console.log('sessionToken dans localStorage:', !!sessionToken);
                
                if (!currentUser || !sessionToken) {
                    console.log('‚ùå Donn√©es de session manquantes');
                    console.log('currentUser:', currentUser);
                    console.log('sessionToken:', sessionToken);
                    
                    // Nettoyer les donn√©es corrompues
                    localStorage.removeItem('current_user');
                    localStorage.removeItem('session_token');
                    
                    alert('‚ö†Ô∏è Session expir√©e. Vous allez √™tre redirig√© vers la page de connexion.');
                    window.location.replace('index.html');
                    return;
                }
                
                // Tester si les donn√©es sont valides
                const user = JSON.parse(currentUser);
                
                if (!user || !user.nom_user || !user.user_id) {
                    throw new Error('Donn√©es utilisateur invalides');
                }
                
                console.log('‚úÖ Utilisateur connect√©:', user.nom_user, '(Admin:', user.is_admin, ')');
                
                // Marquer la session comme valide
                window.sessionValid = true;
                window.currentUserData = user;
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la v√©rification des donn√©es utilisateur:', error);
                
                // Nettoyer les donn√©es corrompues
                localStorage.removeItem('current_user');
                localStorage.removeItem('session_token');
                
                alert('‚ö†Ô∏è Donn√©es de session corrompues. Reconnexion n√©cessaire.');
                window.location.replace('index.html');
                return;
            }
        })();
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-douane-vert to-gray-800 font-sans text-white overflow-x-hidden overscroll-contain">
    <div class="max-w-6xl mx-auto p-5">
        <header class="flex justify-between items-center flex-wrap gap-5 mb-8 bg-gray-900/80 p-8 rounded-2xl shadow-xl text-white border border-douane-or/30">
            <div class="header-main">
                <h1 class="text-4xl font-bold text-white mb-3">üèõÔ∏è Syst√®me de Classification Tarifaire CEDEAO</h1>
                <p class="text-xl text-douane-or font-medium">Direction G√©n√©rale des Douanes de C√¥te d'Ivoire - TEC SH 2022</p>
                <div id="ai-status" class="mt-4 px-4 py-2 bg-douane-vert/20 rounded-lg border border-douane-or/30">
                    <span class="text-douane-or font-semibold">üîÑ Initialisation...</span>
                </div>
            </div>
            
            <!-- Zone utilisateur et d√©connexion -->
            <div class="flex flex-wrap items-center gap-5">
                <!-- Informations utilisateur -->
                <div class="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-lg border border-douane-or/30">
                    <div class="flex items-center space-x-2">
                        <span class="text-douane-or">üë§</span>
                        <div class="text-sm">
                            <div id="user-name" class="font-semibold">Chargement...</div>
                            <div id="user-role" class="text-xs text-white/70">Utilisateur</div>
                        </div>
                    </div>
                </div>
                
                <!-- Menu utilisateur avec d√©connexion -->
                <div class="relative" id="user-menu">
                    <button id="user-menu-btn" 
                        class="bg-douane-vert/90 backdrop-blur-sm text-white border border-douane-or/50 px-4 py-2 rounded-lg font-medium cursor-pointer flex items-center gap-2 transition-all duration-300 shadow-lg hover:bg-douane-or/90 hover:-translate-y-0.5 hover:shadow-xl hover:border-douane-or">
                        <span>‚öôÔ∏è</span>
                        <span>Menu</span>
                        <span class="transition-transform duration-300" id="menu-arrow">‚ñº</span>
                    </button>
                    
                    <!-- Dropdown menu -->
                    <div id="user-dropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border opacity-0 invisible transform translate-y-2 transition-all duration-300 z-50">
                        <div class="py-2">
                            <div class="px-4 py-3 border-b border-gray-200">
                                <div class="flex items-center space-x-2">
                                    <span class="text-2xl">üë§</span>
                                    <div>
                                        <div id="dropdown-user-name" class="font-semibold text-gray-800">-</div>
                                        <div class="text-sm text-gray-500" id="dropdown-user-email">-</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bouton Panneau Admin (visible seulement pour les admins) -->
                            <a href="admin.html" id="admin-panel-link" class="hidden flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors">
                                <span class="mr-3">üëë</span>
                                Panneau Administrateur
                            </a>
                            
                            <a href="historique.html" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors">
                                <span class="mr-3">üìã</span>
                                Historique
                            </a>
                            
                            <hr class="my-2">
                            
                            <!-- Bouton de d√©connexion -->
                            <button id="logout-btn" 
                                class="w-full flex items-center px-4 py-3 text-red-600 hover:bg-red-50 transition-colors font-medium">
                                <span class="mr-3">üö™</span>
                                D√©connexion
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="relative z-[1000]">
                    <button id="sections-dropdown-btn" class="bg-douane-vert/90 backdrop-blur-sm text-white border border-douane-or/50 px-5 py-3 rounded-full text-base font-semibold cursor-pointer flex items-center gap-2.5 transition-all duration-300 shadow-lg hover:bg-douane-or/90 hover:-translate-y-0.5 hover:shadow-xl hover:border-douane-or">
                        üìö Aper√ßu des Sections <span class="dropdown-arrow transition-transform duration-300">‚ñº</span>
                    </button>
                    
                    <!-- Dropdown avec ajustement automatique de position -->
                    <div id="sections-dropdown-content" class="absolute top-full right-0 mt-2 bg-white rounded-2xl shadow-2xl min-w-96 max-w-lg opacity-0 invisible transform translate-y-2 transition-all duration-300">
                        <div class="bg-gradient-to-r from-douane-vert to-douane-or p-5 text-white rounded-t-2xl">
                            <h4 class="text-lg font-bold mb-3">21 Sections Tarifaires CEDEAO</h4>
                            <input type="text" id="sections-search" placeholder="Rechercher une section..." class="w-full px-4 py-2 rounded-full border-none bg-white/90 text-gray-800 placeholder-gray-500">
                        </div>
                        
                        <div id="sections-list" class="max-h-80 overflow-y-auto p-3 text-gray-800 space-y-2">
                            <!-- Les sections seront charg√©es dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <main>
            <div id="statistics" class="bg-gradient-to-r from-gray-800/90 to-douane-vert/90 p-6 rounded-2xl shadow-xl mb-6 text-center">
                <h2 class="text-2xl font-bold text-white mb-6">üìä Statistiques du syst√®me</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="bg-white/20 backdrop-blur-sm p-6 rounded-xl border border-douane-or/30 hover:bg-white/30 transition-all duration-300">
                        <span class="block text-2xl font-bold text-white mb-2">21</span>
                        <span class="text-sm text-white/80">Sections</span>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm p-6 rounded-xl border border-douane-or/30 hover:bg-white/30 transition-all duration-300">
                        <span class="block text-2xl font-bold text-white mb-2">97</span>
                        <span class="text-sm text-white/80">Chapitres</span>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm p-6 rounded-xl border border-douane-or/30 hover:bg-white/30 transition-all duration-300">
                        <span class="block text-2xl font-bold text-white mb-2">5000+</span>
                        <span class="text-sm text-white/80">Codes tarifaires</span>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm p-6 rounded-xl border border-douane-or/30 hover:bg-white/30 transition-all duration-300">
                        <span class="block text-2xl font-bold text-white mb-2">2022</span>
                        <span class="text-sm text-white/80">Version SH</span>
                    </div>
                </div>
            </div>

            <div id="real-time-suggestions" class="hidden bg-vert-50/90 p-4 space-x-4 rounded-xl mb-6 border-l-4 border-douane-vert">
                <!-- Les suggestions appara√Ætront ici -->
            </div>

            <div class="bg-white/95 p-8 rounded-2xl shadow-xl mb-8">
                <h2 class="text-2xl font-bold text-douane-vert mb-6 flex items-center gap-2">üîç Recherche de Classification</h2>
                <div class="mb-6">
                    <label for="product-description" class="block mb-2 font-semibold text-gray-700">Description du produit :</label>
                    <textarea 
                    id="product-description"
                    class="w-full p-4 border-2 border-gray-200 rounded-xl text-base resize-y text-gray-800 bg-white placeholder-gray-500 focus:outline-none focus:border-douane-vert focus:ring-4 focus:ring-douane-vert/20 focus:bg-white transition-all duration-300"
                        placeholder="D√©crivez le produit √† classer (ex: riz blanchi, v√©hicule automobile, textile en coton...)"
                        rows="3"
                    ></textarea>
                </div>
                <button
                    id="classify-btn"
                    class="inline-flex items-center gap-3 bg-gradient-to-r from-douane-vert to-douane-or text-white px-8 py-4 text-lg font-semibold rounded-xl hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-douane-or/50">
                    üéØ Classifier le produit
                </button>
            </div>

            <div id="loading" class="hidden text-center bg-white/95 p-12 rounded-2xl shadow-xl mb-8">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-douane-vert rounded-full animate-spin mx-auto mb-6"></div>
                <p class="text-gray-700 font-medium">Recherche de la classification en cours...</p>
            </div>

            <div id="results" class="hidden bg-white/95 p-8 rounded-2xl shadow-xl mb-8 text-gray-800">
                <h3 class="text-2xl font-bold text-douane-vert mb-6">üìã R√©sultats de la classification</h3>
                <div id="classification-result" class="text-gray-800">
                    <!-- Les r√©sultats appara√Ætront ici -->
                </div>
                        
                <div id="specific-codes" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h4 class="text-xl font-bold text-douane-or mb-4">üéØ Codes tarifaires sp√©cifiques trouv√©s</h4>
                    <div id="codes-list">
                        <!-- Les codes sp√©cifiques appara√Ætront ici -->
                    </div>
                </div>
            </div>

            <!--Le tableau de classification sera ici-->
            <iframe src="tableau.html" width="100%" height="500px"></iframe>

                 <div class="bg-gradient-to-br from-douane-vert/10 to-douane-or/10 p-8 rounded-2xl border border-douane-or/20 mb-8">
    <h3 class="text-2xl font-bold text-douane-vert mb-6">‚ùì Comment utiliser ce syst√®me</h3>
    
    <ol class="list-decimal list-inside space-y-2 mb-8 text-white-700">
        <li>Saisissez une description d√©taill√©e de votre produit</li>
        <li>Cliquez sur "Classifier le produit"</li>
        <li>Le syst√®me analysera la description et proposera la section appropri√©e</li>
        <li>Consultez les d√©tails de la section et les codes tarifaires correspondants</li>
    </ol>
    
    <h4 class="text-xl font-bold text-douane-vert mb-4">üí° Exemples de descriptions efficaces</h4>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-vert p-4 rounded-lg border-l-4 border-douane-vert shadow-sm">
            <strong class="text-douane-blanc-bold">Animaux :</strong> "Cheval reproducteur de race pure", "Poules pondeuses vivantes"
        </div>
        <div class="bg-vert p-4 rounded-lg border-l-4 border-douane-vert shadow-sm">
            <strong class="text-douane-blanc-bold">Produits alimentaires :</strong> "Riz blanchi long grain", "Tomates fra√Æches", "Huile d'olive vierge"
        </div>
        <div class="bg-vert p-4 rounded-lg border-l-4 border-douane-vert shadow-sm">
            <strong class="text-douane-blanc-bold">Textiles :</strong> "Tissu 100% coton", "Chemise en soie", "Jean en denim"
        </div>
        <div class="bg-vert p-4 rounded-lg border-l-4 border-douane-vert shadow-sm">
            <strong class="text-douane-blanc-bold">V√©hicules :</strong> "Voiture d'occasion diesel", "Camion de transport", "Moto 250cc"
        </div>
    </div>
</div>
        </main>

        <footer class="text-center text-white/80 py-8 mt-12 border-t border-white/20">
            <p>&copy; 2025 - Direction G√©n√©rale des Douanes de C√¥te d'Ivoire</p>
        </footer>
    </div>

    <!-- Modal de confirmation de d√©connexion -->
    <div id="logout-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[9999]">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üö™</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Confirmer la d√©connexion</h3>
                <p class="text-gray-600 mb-6">
                    √ätes-vous s√ªr de vouloir vous d√©connecter du syst√®me CEDEAO ?<br>
                    <small class="text-gray-500">Toutes les donn√©es non sauvegard√©es seront perdues.</small>
                </p>
                <div class="flex space-x-4">
                    <button id="cancel-logout" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-xl font-medium hover:bg-gray-300 transition-colors">
                        ‚ùå Annuler
                    </button>
                    <button id="confirm-logout" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                        <span id="logout-text">üö™ D√©connexion</span>
                        <span id="logout-spinner" class="hidden">üîÑ D√©connexion...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ SCRIPTS DE GESTION DE L'AUTHENTIFICATION CORRIG√âS -->
    <script>
        // ‚úÖ GESTIONNAIRE D'AUTHENTIFICATION ROBUSTE
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.sessionToken = null;
                this.isInitialized = false;
                
                // V√©rifier imm√©diatement si la session est valide
                if (!window.sessionValid) {
                    this.redirectToLogin('Session invalide');
                    return;
                }
                
                this.loadUserInfo();
                this.initializeUI();
                this.setupEventListeners();
                this.setupSessionMonitoring();
                this.isInitialized = true;
                
                console.log('‚úÖ AuthManager initialis√© avec succ√®s');
            }

            loadUserInfo() {
                try {
                    // Utiliser les donn√©es d√©j√† valid√©es
                    this.currentUser = window.currentUserData;
                    this.sessionToken = localStorage.getItem('session_token');
                    
                    if (!this.currentUser || !this.sessionToken) {
                        throw new Error('Donn√©es de session manquantes');
                    }
                    
                    // ‚úÖ VALIDATION STRICTE DES DONN√âES ADMIN
                    if (typeof this.currentUser.is_admin !== 'boolean') {
                        // Convertir les valeurs num√©riques en boolean
                        this.currentUser.is_admin = Boolean(this.currentUser.is_admin);
                    }
                    
                    console.log('‚úÖ Session utilisateur valid√©e:', {
                        nom: this.currentUser.nom_user,
                        id: this.currentUser.user_id,
                        admin: this.currentUser.is_admin,
                        email: this.currentUser.email
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des donn√©es utilisateur:', error);
                    this.redirectToLogin('Erreur de session');
                }
            }

            initializeUI() {
                if (!this.currentUser) return;
                
                try {
                    // Mettre √† jour les informations utilisateur dans l'interface
                    const userNameEl = document.getElementById('user-name');
                    const userRoleEl = document.getElementById('user-role');
                    const dropdownNameEl = document.getElementById('dropdown-user-name');
                    const dropdownEmailEl = document.getElementById('dropdown-user-email');
                    const adminLinkEl = document.getElementById('admin-panel-link');
                    
                    if (userNameEl) userNameEl.textContent = this.currentUser.nom_user;
                    if (userRoleEl) userRoleEl.textContent = this.currentUser.is_admin ? 'Administrateur' : 'Utilisateur';
                    if (dropdownNameEl) dropdownNameEl.textContent = this.currentUser.nom_user;
                    if (dropdownEmailEl) dropdownEmailEl.textContent = this.currentUser.email || this.currentUser.identifiant_user;

                    // ‚úÖ AFFICHAGE CORRECT DU LIEN ADMIN
                    if (adminLinkEl) {
                        if (this.currentUser.is_admin === true) {
                            adminLinkEl.classList.remove('hidden');
                            console.log('‚úÖ Lien administrateur activ√© pour:', this.currentUser.nom_user);
                        } else {
                            adminLinkEl.classList.add('hidden');
                            console.log('‚ÑπÔ∏è Lien administrateur masqu√© (utilisateur standard)');
                        }
                    }
                    
                    console.log('‚úÖ Interface utilisateur mise √† jour');
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de la mise √† jour de l\'interface:', error);
                }
            }

            setupEventListeners() {
                // Menu utilisateur toggle
                const userMenuBtn = document.getElementById('user-menu-btn');
                const userDropdown = document.getElementById('user-dropdown');
                const menuArrow = document.getElementById('menu-arrow');

                if (userMenuBtn && userDropdown && menuArrow) {
                    userMenuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isVisible = !userDropdown.classList.contains('opacity-0');
                        
                        if (isVisible) {
                            this.hideDropdown(userDropdown, menuArrow);
                        } else {
                            this.showDropdown(userDropdown, menuArrow);
                        }
                    });
                }

                // Fermer les dropdowns en cliquant ailleurs
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#user-menu') && userDropdown) {
                        this.hideDropdown(userDropdown, menuArrow);
                    }
                });

                // Bouton de d√©connexion
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showLogoutModal();
                    });
                }

                // Modal de d√©connexion
                const cancelLogout = document.getElementById('cancel-logout');
                const confirmLogout = document.getElementById('confirm-logout');
                
                if (cancelLogout) {
                    cancelLogout.addEventListener('click', () => {
                        this.hideLogoutModal();
                    });
                }
                
                if (confirmLogout) {
                    confirmLogout.addEventListener('click', () => {
                        this.performLogout();
                    });
                }

                // Raccourci clavier Ctrl+Alt+L
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.altKey && e.key === 'l') {
                        e.preventDefault();
                        this.showLogoutModal();
                    }
                });
            }
            
            // ‚úÖ NOUVEAU: Surveillance de la session
            setupSessionMonitoring() {
                // V√©rifier la validit√© de la session toutes les 30 secondes
                setInterval(() => {
                    this.validateSession();
                }, 30000);
                
                // Surveillance des changements dans localStorage
                window.addEventListener('storage', (e) => {
                    if (e.key === 'current_user' || e.key === 'session_token') {
                        if (!e.newValue) {
                            console.log('‚ö†Ô∏è Session supprim√©e dans un autre onglet');
                            this.redirectToLogin('Session expir√©e');
                        }
                    }
                });
            }
            
            // ‚úÖ NOUVEAU: Validation de la session
            validateSession() {
                try {
                    const currentUser = localStorage.getItem('current_user');
                    const sessionToken = localStorage.getItem('session_token');
                    
                    if (!currentUser || !sessionToken) {
                        console.log('‚ö†Ô∏è Session perdue, redirection...');
                        this.redirectToLogin('Session expir√©e');
                        return false;
                    }
                    
                    const user = JSON.parse(currentUser);
                    if (!user || !user.nom_user || !user.user_id) {
                        throw new Error('Donn√©es utilisateur corrompues');
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Erreur validation session:', error);
                    this.redirectToLogin('Session corrompue');
                    return false;
                }
            }

            showDropdown(dropdown, arrow) {
                if (dropdown && arrow) {
                    dropdown.classList.remove('opacity-0', 'invisible', 'translate-y-2');
                    dropdown.classList.add('opacity-100', 'visible', 'translate-y-0');
                    arrow.style.transform = 'rotate(180deg)';
                }
            }

            hideDropdown(dropdown, arrow) {
                if (dropdown && arrow) {
                    dropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
                    dropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
                    arrow.style.transform = 'rotate(0deg)';
                }
            }

            showLogoutModal() {
                const modal = document.getElementById('logout-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            }

            hideLogoutModal() {
                const modal = document.getElementById('logout-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }

            async performLogout() {
                const logoutText = document.getElementById('logout-text');
                const logoutSpinner = document.getElementById('logout-spinner');
                const confirmBtn = document.getElementById('confirm-logout');
                
                // Interface de chargement
                if (logoutText) logoutText.classList.add('hidden');
                if (logoutSpinner) logoutSpinner.classList.remove('hidden');
                if (confirmBtn) confirmBtn.disabled = true;

                try {
                    // Appel √† logout.php
                    const response = await fetch('logout.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.currentUser.user_id,
                            session_token: this.sessionToken
                        })
                    });

                    const result = await response.json();
                    console.log('R√©sultat d√©connexion:', result);

                    // Nettoyer la session locale dans tous les cas
                    this.clearSession();

                    if (result.success || result.session_destroyed) {
                        console.log('‚úÖ D√©connexion r√©ussie');
                        this.showLogoutSuccess();
                        
                        // Redirection apr√®s 1.5 secondes
                        setTimeout(() => {
                            window.location.replace('index.html');
                        }, 1500);
                    } else {
                        throw new Error(result.message || 'Erreur de d√©connexion');
                    }

                } catch (error) {
                    console.error('‚ùå Erreur lors de la d√©connexion:', error);
                    
                    // Nettoyer quand m√™me et rediriger
                    this.clearSession();
                    window.location.replace('index.html');
                }
            }

            clearSession() {
                const keysToRemove = [
                    'current_user',
                    'session_token',
                    'user_preferences',
                    'classification_cache',
                    'temp_data'
                ];

                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });

                sessionStorage.clear();
                
                // Nettoyer les variables globales
                window.sessionValid = false;
                window.currentUserData = null;
                
                console.log('üßπ Session nettoy√©e compl√®tement');
            }

            showLogoutSuccess() {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-lg z-[10000] flex items-center space-x-2';
                successDiv.innerHTML = `
                    <span>‚úÖ</span>
                    <span>D√©connexion r√©ussie ! Redirection...</span>
                `;

                document.body.appendChild(successDiv);

                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 3000);
            }

            redirectToLogin(reason = 'Session expir√©e') {
                console.log(`üîÑ Redirection vers la page d'authentification: ${reason}`);
                
                // Nettoyer compl√®tement
                this.clearSession();
                
                // Afficher un message √† l'utilisateur
                if (reason !== 'Session invalide') {
                    alert(`‚ö†Ô∏è ${reason}. Vous allez √™tre redirig√© vers la page de connexion.`);
                }
                
                window.location.replace('index.html');
            }

            // ‚úÖ M√âTHODE PUBLIQUE POUR V√âRIFIER SI L'UTILISATEUR EST ADMIN
            isAdmin() {
                return this.currentUser && this.currentUser.is_admin === true;
            }
            
            // ‚úÖ M√âTHODE PUBLIQUE POUR OBTENIR LES INFOS UTILISATEUR
            getUserInfo() {
                return this.currentUser;
            }
        }

        // ‚úÖ INITIALISATION S√âCURIS√âE
        let authManager;
        document.addEventListener('DOMContentLoaded', function() {
            // Attendre un peu que le DOM soit compl√®tement charg√©
            setTimeout(() => {
                try {
                    authManager = new AuthManager();
                    window.authManager = authManager; // Pour debug
                    console.log('üîê Gestionnaire d\'authentification initialis√© avec succ√®s');
                    
                    // V√©rifier si l'utilisateur peut acc√©der √† admin.html
                    if (window.location.pathname.includes('admin.html') && !authManager.isAdmin()) {
                        console.log('‚ùå Acc√®s admin refus√©');
                        alert('‚ùå Acc√®s r√©serv√© aux administrateurs uniquement.');
                        window.location.replace('system.html');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'initialisation de AuthManager:', error);
                    
                    // En cas d'erreur, nettoyer et rediriger
                    localStorage.removeItem('current_user');
                    localStorage.removeItem('session_token');
                    window.location.replace('index.html');
                }
            }, 100);
        });

        // ‚úÖ FONCTION GLOBALE POUR D√âCONNEXION D'URGENCE
        window.emergencyLogout = function() {
            console.log('üö® D√©connexion d\'urgence activ√©e');
            localStorage.clear();
            sessionStorage.clear();
            window.location.replace('index.html');
        };
        
        // ‚úÖ PROTECTION CONTRE LA MANIPULATION DU localStorage
        const originalSetItem = localStorage.setItem;
        const originalRemoveItem = localStorage.removeItem;
        const originalClear = localStorage.clear;
        
        // Surveiller les modifications critiques
        localStorage.setItem = function(key, value) {
            if (key === 'current_user' || key === 'session_token') {
                console.log(`üîç Modification localStorage d√©tect√©e: ${key}`);
                
                // Valider les nouvelles donn√©es
                if (key === 'current_user' && value) {
                    try {
                        const userData = JSON.parse(value);
                        if (!userData.nom_user || !userData.user_id) {
                            console.error('‚ùå Tentative de stockage de donn√©es utilisateur invalides');
                            return;
                        }
                    } catch (e) {
                        console.error('‚ùå Donn√©es utilisateur JSON invalides');
                        return;
                    }
                }
            }
            return originalSetItem.call(this, key, value);
        };
        
        // ‚úÖ SAUVEGARDE DES DONN√âES IMPORTANTES P√âRIODIQUEMENT
        setInterval(() => {
            if (window.authManager && window.authManager.isInitialized) {
                const currentUser = localStorage.getItem('current_user');
                const sessionToken = localStorage.getItem('session_token');
                
                if (currentUser && sessionToken) {
                    // Sauvegarder dans sessionStorage comme backup
                    sessionStorage.setItem('backup_current_user', currentUser);
                    sessionStorage.setItem('backup_session_token', sessionToken);
                }
            }
        }, 60000); // Chaque minute
    </script>

    <!-- Chargement des scripts dans le bon ordre -->
    <script src="codes-tarifaires.js"></script>
    <script>
        // ‚úÖ CHARGEMENT ROBUSTE DU DATABASE MANAGER
        const script = document.createElement('script');
        script.src = './database-manager.js';
        script.onerror = function() {
            console.warn('database-manager.js non trouv√© dans le dossier actuel, essai dossier database...');
            const script2 = document.createElement('script');
            script2.src = '../database/database-manager.js';
            script2.onerror = function() {
                console.error('database-manager.js introuvable, utilisation du fallback');
                window.createFallbackDatabaseManager();
            };
            document.head.appendChild(script2);
        };
        document.head.appendChild(script);
        
        // ‚úÖ DATABASE MANAGER DE SECOURS AM√âLIOR√â
        window.createFallbackDatabaseManager = function() {
            console.log('üîß Cr√©ation du DatabaseManager fallback am√©lior√©');
            window.DatabaseManager = class {
                constructor() {
                    this.possibleUrls = [
                        './api.php',
                        'api.php', 
                        'http://localhost/Classification_Tarifaire_CEDEAO/1MILLION/api.php'
                    ];
                    this.apiUrl = null;
                    console.log('‚úÖ DatabaseManager fallback initialis√©');
                }
                
                async findWorkingUrl() {
                    for (const url of this.possibleUrls) {
                        try {
                            const response = await fetch(url + '?action=test_connection', {
                                method: 'GET',
                                timeout: 5000
                            });
                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    this.apiUrl = url;
                                    console.log(`‚úÖ URL API fonctionnelle trouv√©e: ${url}`);
                                    return true;
                                }
                            }
                        } catch (error) {
                            console.log(`‚ùå ${url}: ${error.message}`);
                        }
                    }
                    console.warn('‚ö†Ô∏è Aucune URL API accessible');
                    return false;
                }
                
                async testConnection() {
                    if (!this.apiUrl) {
                        await this.findWorkingUrl();
                    }
                    
                    if (!this.apiUrl) {
                        return { success: false, message: 'API non accessible' };
                    }
                    
                    try {
                        const response = await fetch(this.apiUrl + '?action=test_connection');
                        const result = await response.json();
                        console.log('‚úÖ Test de connexion DB r√©ussi');
                        return result;
                    } catch (error) {
                        console.error('‚ùå Test de connexion DB √©chou√©:', error);
                        return { success: false, message: error.message };
                    }
                }
                
                async saveClassifiedProduct(productData) {
                    if (!this.apiUrl) {
                        const found = await this.findWorkingUrl();
                        if (!found) {
                            // Fallback local
                            this.saveToLocalHistory(productData.description_produit, {
                                section: { number: productData.section_produit },
                                confidence: 75,
                                code: productData.code_tarifaire
                            });
                            
                            return { 
                                success: false, 
                                message: 'API non accessible. Sauv√© localement.',
                                fallback: true
                            };
                        }
                    }

                    try {
                        const response = await fetch(this.apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'save_classified_product',
                                product: productData
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('‚úÖ Produit sauvegard√© en base:', result);
                            return result;
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    } catch (error) {
                        console.error('‚ùå Erreur sauvegarde DB:', error);
                        
                        // Fallback local en cas d'erreur
                        this.saveToLocalHistory(productData.description_produit, {
                            section: { number: productData.section_produit },
                            confidence: 75,
                            code: productData.code_tarifaire
                        });
                        
                        return { 
                            success: false, 
                            message: `Erreur DB: ${error.message}. Sauv√© localement.`,
                            fallback: true
                        };
                    }
                }
                
                saveToLocalHistory(description, result) {
                    try {
                        let history = JSON.parse(localStorage.getItem('classification_history') || '[]');
                        const entry = {
                            timestamp: new Date().toISOString(),
                            description: description,
                            section: result.section?.number || 'Inconnu',
                            title: result.section?.title || 'Section inconnue',
                            confidence: result.confidence || 0,
                            code: result.code || 'N/A'
                        };
                        
                        history.unshift(entry);
                        if (history.length > 100) history = history.slice(0, 100);
                        localStorage.setItem('classification_history', JSON.stringify(history));
                        
                        console.log('‚úÖ Entr√©e sauvegard√©e dans l\'historique local');
                        return entry;
                    } catch (error) {
                        console.error('‚ùå Erreur sauvegarde locale:', error);
                        return null;
                    }
                }
            };
        };
    </script>
    <script src="ai-classifier.js"></script>
    <script>
        // ‚úÖ SCRIPT DE DIAGNOSTIC INT√âGR√â ET AM√âLIOR√â
        (function() {
            console.log('üîß DIAGNOSTIC DU SYST√àME COMPLET');
            
            const checks = [
                { name: 'SessionValid', obj: window.sessionValid, expected: true },
                { name: 'CurrentUserData', obj: window.currentUserData, type: 'object' },
                { name: 'DatabaseManager', obj: window.DatabaseManager, type: 'function' },
                { name: 'TariffAIClassifier', obj: window.TariffAIClassifier, type: 'function' },
                { name: 'codesSpecifiques', obj: window.codesSpecifiques, type: 'object' }
            ];
            
            let allGood = true;
            
            checks.forEach(check => {
                if (check.expected !== undefined) {
                    if (check.obj === check.expected) {
                        console.log(`‚úÖ ${check.name}: ${check.obj} (attendu)`);
                    } else {
                        console.error(`‚ùå ${check.name}: ${check.obj} (attendu: ${check.expected})`);
                        allGood = false;
                    }
                } else if (check.obj) {
                    console.log(`‚úÖ ${check.name}: Disponible (${typeof check.obj})`);
                } else {
                    console.error(`‚ùå ${check.name}: MANQUANT`);
                    allGood = false;
                }
            });
            
            // V√©rification des donn√©es utilisateur
            if (window.currentUserData) {
                const user = window.currentUserData;
                console.log('üë§ Utilisateur actuel:', {
                    nom: user.nom_user,
                    id: user.user_id,
                    email: user.email,
                    admin: user.is_admin,
                    type_admin: typeof user.is_admin
                });
                
                if (typeof user.is_admin !== 'boolean') {
                    console.warn('‚ö†Ô∏è is_admin n\'est pas un boolean:', typeof user.is_admin);
                }
            }
            
            console.log(allGood ? '‚úÖ DIAGNOSTIC: SYST√àME OK' : '‚ùå DIAGNOSTIC: PROBL√àMES D√âTECT√âS');
            
            // Fonction pour d√©bugger manuellement
            window.debugSystem = function() {
                console.log('üêõ DEBUG MANUEL D√âTAILL√â');
                console.log('authManager:', window.authManager);
                console.log('dbManager:', window.dbManager);
                console.log('currentUserData:', window.currentUserData);
                console.log('localStorage current_user:', localStorage.getItem('current_user'));
                console.log('localStorage session_token:', !!localStorage.getItem('session_token'));
                
                if (window.authManager) {
                    console.log('authManager.isAdmin():', window.authManager.isAdmin());
                    console.log('authManager.getUserInfo():', window.authManager.getUserInfo());
                }
                
                // Test de persistance
                console.log('üß™ TEST DE PERSISTANCE');
                localStorage.setItem('test_persistence', 'OK');
                console.log('Test localStorage:', localStorage.getItem('test_persistence'));
                localStorage.removeItem('test_persistence');
            };
            
            // Auto-test de persistance
            setTimeout(() => {
                const testKey = 'system_test_' + Date.now();
                localStorage.setItem(testKey, 'test_value');
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === 'test_value') {
                    console.log('‚úÖ Test de persistance localStorage: OK');
                } else {
                    console.error('‚ùå Test de persistance localStorage: √âCHEC');
                }
            }, 1000);
        })();
    </script>
    <script src="script-advanced.js"></script>
</body>
</html>