<!--index.html-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me CEDEAO - Authentification Requise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'douane-vert': '#1B5E20',
                        'douane-or': '#FFD700'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-douane-vert via-green-800 to-gray-900 overflow-x-hidden overflow-y-auto">
    
    <!-- Protection et redirection imm√©diate -->
    <script>
        // V√©rification imm√©diate de l'authentification
        (function() {
            const currentUser = localStorage.getItem('current_user');
            const sessionToken = localStorage.getItem('session_token');
            
            if (currentUser && sessionToken) {
                try {
                    const user = JSON.parse(currentUser);
                    // Utilisateur connect√©, rediriger vers le syst√®me
                    console.log('Utilisateur connect√© d√©tect√©:', user.nom_user);
                    window.location.replace('system.html');
                    return;
                } catch (e) {
                    // Session corrompue, nettoyer
                    localStorage.removeItem('current_user');
                    localStorage.removeItem('session_token');
                }
            }
            
            // Pas connect√©, continuer avec la page d'authentification
            console.log('Aucune session valide - Affichage de l\'authentification');
        })();
    </script>
    
    <!-- Arri√®re-plan anim√© -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -right-40 w-96 h-96 bg-douane-or/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-douane-or/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-douane-vert/30 rounded-full blur-2xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>
    
    <div class="relative z-10 min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl p-10 w-full max-w-md fade-in pulse-glow">
            
            <!-- Logo et en-t√™te -->
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-r from-douane-vert to-douane-or rounded-full mx-auto mb-6 flex items-center justify-center shadow-xl">
                    <span class="text-4xl text-white">üèõÔ∏è</span>
                </div>
                <h1 class="text-3xl font-bold text-douane-vert mb-3">Syst√®me CEDEAO</h1>
                <p class="text-gray-600 font-medium mb-1">Classification Tarifaire</p>
                <p class="text-gray-600">Direction G√©n√©rale des Douanes</p>
                <p class="text-douane-vert font-semibold">R√©publique de C√¥te d'Ivoire</p>
            </div>

            <!-- Message d'authentification obligatoire -->
            <div class="bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500 p-4 mb-8 rounded-r-xl">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="text-red-500 text-2xl">üîê</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-red-800 font-bold mb-2">Acc√®s S√©curis√©</h3>
                        <p class="text-red-700 text-sm mb-2">
                            L'acc√®s au syst√®me de classification tarifaire est strictement r√©serv√© au personnel autoris√© des services douaniers.
                        </p>
                        <p class="text-red-600 text-xs font-medium">
                            Authentification obligatoire ‚Ä¢ TEC SH 2022
                        </p>
                    </div>
                </div>
            </div>

            <!-- Formulaire de connexion -->
            <form id="authForm" class="space-y-6">
                <div>
                    <label for="identifiant" class="flex items-center text-sm font-bold text-gray-700 mb-3">
                        <span class="mr-2">üÜî</span> Identifiant ou Email
                    </label>
                    <input type="text" id="identifiant" required
                        class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg focus:ring-3 focus:ring-douane-vert/50 focus:border-douane-vert transition-all duration-300 bg-gray-50 focus:bg-white shadow-inner"
                        placeholder="Votre identifiant ou email">
                </div>

                <div>
                    <label for="password" class="flex items-center text-sm font-bold text-gray-700 mb-3">
                        <span class="mr-2">üîë</span> Mot de passe
                    </label>
                    <input type="password" id="password" required
                        class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg focus:ring-3 focus:ring-douane-vert/50 focus:border-douane-vert transition-all duration-300 bg-gray-50 focus:bg-white shadow-inner"
                        placeholder="Votre mot de passe">
                </div>

                <button type="submit" id="loginBtn"
                    class="w-full bg-gradient-to-r from-douane-vert via-green-700 to-douane-vert text-white py-4 px-6 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 active:scale-95">
                    <span id="login-text">üöÄ Acc√©der au Syst√®me</span>
                    <div id="login-spinner" class="hidden flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Connexion en cours...
                    </div>
                </button>
            </form>

            <!-- R√©sultat de connexion -->
            <div id="authResult" class="mt-6 p-4 rounded-xl hidden"></div>

            <!-- Informations syst√®me -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="text-center text-gray-500 space-y-2">
                    <p class="flex items-center justify-center text-sm">
                        <span class="mr-2">üõ°Ô∏è</span>
                        Syst√®me S√©curis√© ‚Ä¢ Confidentiel
                    </p>
                    <p class="text-xs">
                        TEC SH 2022 ‚Ä¢ CEDEAO/UEMOA
                    </p>
                    <p class="text-xs font-medium text-douane-vert">
                        &copy; 2025 R√©publique de C√¥te d'Ivoire
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Script d'authentification -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const authForm = document.getElementById('authForm');
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('login-text');
            const loginSpinner = document.getElementById('login-spinner');
            const authResult = document.getElementById('authResult');

            // Gestion du formulaire de connexion
            authForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const identifiant = document.getElementById('identifiant').value.trim();
                const password = document.getElementById('password').value;
                
                if (!identifiant || !password) {
                    showResult('‚ùå Veuillez saisir vos identifiants', 'error');
                    return;
                }
                
                // Interface de chargement
                setLoading(true);
                
                try {
                    const response = await fetch('./api.php', {
    method: 'POST',
    headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    },
    body: JSON.stringify({
        action: 'login',
        identifiant: identifiant,  // ‚Üê CHANGEMENT ICI : pas "email"
        password: password
    })
});
                    if (!response.ok) {
                        throw new Error(`Erreur serveur: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Sauvegarder la session
                        localStorage.setItem('current_user', JSON.stringify(result.user));
                        if (result.session && result.session.token) {
                            localStorage.setItem('session_token', result.session.token);
                        }
                        
                        // Affichage du succ√®s
                        showResult(`‚úÖ Bienvenue ${result.user.nom_user}`, 'success');
                        
                        // Log de connexion
                        console.log('Connexion r√©ussie:', result.user);
                        
                        // Redirection vers le syst√®me
                        setTimeout(() => {
                            window.location.replace('system.html');
                        }, 1500);
                        
                    } else {
                        throw new Error(result.message || 'Identifiants incorrects');
                    }
                    
                } catch (error) {
                    console.error('Erreur d\'authentification:', error);
                    
                    let errorMessage = 'Erreur de connexion';
                    if (error.message.includes('fetch')) {
                        errorMessage = 'Serveur inaccessible. V√©rifiez votre connexion.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showResult(`‚ùå ${errorMessage}`, 'error');
                } finally {
                    setLoading(false);
                }
            });

            function setLoading(loading) {
                loginBtn.disabled = loading;
                if (loading) {
                    loginText.classList.add('hidden');
                    loginSpinner.classList.remove('hidden');
                    loginBtn.classList.add('opacity-90', 'cursor-not-allowed');
                } else {
                    loginText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                    loginBtn.classList.remove('opacity-90', 'cursor-not-allowed');
                }
            }

            function showResult(message, type) {
                const colors = {
                    success: 'bg-green-100 border-green-300 text-green-800',
                    error: 'bg-red-100 border-red-300 text-red-800',
                    info: 'bg-blue-100 border-blue-300 text-blue-800'
                };
                
                authResult.className = `mt-6 p-4 rounded-xl border-2 ${colors[type]} fade-in`;
                authResult.innerHTML = `
                    <div class="font-medium">${message}</div>
                    ${type === 'success' ? '<div class="text-sm mt-1">Redirection automatique...</div>' : ''}
                `;
                authResult.classList.remove('hidden');
                
                // Masquer apr√®s 5 secondes pour les erreurs
                if (type === 'error') {
                    setTimeout(() => {
                        authResult.classList.add('hidden');
                    }, 5000);
                }
            }

            // Focus automatique sur le premier champ
            document.getElementById('identifiant').focus();
            
            // Enter sur le premier champ passe au second
            document.getElementById('identifiant').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('password').focus();
                }
            });
        });

        // Protection contre l'acc√®s direct aux autres pages
        window.addEventListener('storage', function(e) {
            if (e.key === 'current_user' && e.newValue) {
                // Utilisateur connect√© dans un autre onglet
                window.location.reload();
            }
        });
        
        console.log('üîê Page d\'authentification CEDEAO charg√©e');
        console.log('üõ°Ô∏è Acc√®s s√©curis√© - Authentification requise');
    </script>
</body>
</html>