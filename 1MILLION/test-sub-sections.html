<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Classification avec Sous-sections - CEDEAO</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        
        .sub-section-info {
            background-color: #e7f3ff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .precision-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .precision-section { background-color: #ffc107; color: #000; }
        .precision-chapitre { background-color: #17a2b8; color: #fff; }
        .precision-sous-code { background-color: #28a745; color: #fff; }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .code-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 5px 8px;
            border-radius: 3px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test du Système de Classification avec Sous-sections</h1>
        <p>Ce test vérifie la capacité du système à identifier des codes tarifaires spécifiques et des sous-sections.</p>
        
        <div class="test-section">
            <h2>Test Interactif</h2>
            <textarea id="testDescription" class="test-input" rows="3" placeholder="Entrez une description de produit à classifier...">Chevaux reproducteurs de race pure</textarea>
            <button onclick="testClassification()">Classifier ce produit</button>
            <div id="interactiveResult"></div>
        </div>
        
        <div class="test-section">
            <h2>Tests Prédéfinis</h2>
            <button onclick="runAllTests()">Exécuter tous les tests</button>
            <button onclick="runSpecificTests()">Tests codes spécifiques</button>
            <button onclick="runSubCodeTests()">Tests sous-codes</button>
            <div id="testResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Statistiques de Performance</h2>
            <div id="performanceStats"></div>
        </div>
    </div>

    <!-- Chargement des scripts nécessaires -->
    <script src="codes-tarifaires.js"></script>
    <script src="ai-classifier.js"></script>

    <script>
        // Initialisation du classificateur
        let classifier;
        let testResults = [];
        
        // Tests prédéfinis avec résultats attendus
        const predefinedTests = [
            {
                description: "Chevaux reproducteurs de race pure",
                expectedSection: "I",
                expectedPrecision: "sous-code",
                expectedCode: "0101.21.00.00"
            },
            {
                description: "Bovins domestiques reproducteurs de race pure",
                expectedSection: "I",
                expectedPrecision: "sous-code",
                expectedCode: "0102.21.00.00"
            },
            {
                description: "Porcs d'un poids inférieur à 50 kg",
                expectedSection: "I",
                expectedPrecision: "sous-code",
                expectedCode: "0103.91.00.00"
            },
            {
                description: "Tomates fraîches",
                expectedSection: "II",
                expectedPrecision: "chapitre",
                expectedCode: "0702"
            },
            {
                description: "Riz paddy",
                expectedSection: "II",
                expectedPrecision: "chapitre",
                expectedCode: "1006"
            },
            {
                description: "Maïs hybride de semence",
                expectedSection: "II",
                expectedPrecision: "chapitre",
                expectedCode: "1005"
            },
            {
                description: "Smartphone Android",
                expectedSection: "XVI",
                expectedPrecision: "section"
            },
            {
                description: "Ordinateur portable",
                expectedSection: "XVI",
                expectedPrecision: "section"
            }
        ];

        function initializeClassifier() {
            try {
                classifier = new TariffAIClassifier();
                console.log('Classificateur initialisé avec succès');
                return true;
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                return false;
            }
        }

        function testClassification() {
            const description = document.getElementById('testDescription').value.trim();
            const resultDiv = document.getElementById('interactiveResult');
            
            if (!description) {
                resultDiv.innerHTML = '<div class="result error">Veuillez entrer une description de produit.</div>';
                return;
            }
            
            if (!classifier && !initializeClassifier()) {
                resultDiv.innerHTML = '<div class="result error">Erreur d\'initialisation du classificateur.</div>';
                return;
            }
            
            try {
                const startTime = performance.now();
                const results = classifier.classifyWithAI(description);
                const endTime = performance.now();
                const processingTime = (endTime - startTime).toFixed(2);
                
                let html = `<div class="result success">
                    <strong>Classification réussie</strong> (${processingTime}ms)
                    <br><strong>Description:</strong> ${description}
                </div>`;
                
                if (results.length > 0) {
                    results.slice(0, 3).forEach((result, index) => {
                        const precision = result.subSectionAnalysis ? result.subSectionAnalysis.precision : 'section';
                        const precisionClass = `precision-${precision}`;
                        const recommendedCode = result.subSectionAnalysis && result.subSectionAnalysis.recommendedCode 
                            ? result.subSectionAnalysis.recommendedCode.code 
                            : 'Non déterminé';
                        
                        html += `
                        <div class="result">
                            <strong>Résultat ${index + 1}:</strong> Section ${result.section.number} - ${result.section.title}
                            <span class="precision-badge ${precisionClass}">${precision}</span>
                            <br><strong>Confiance:</strong> ${result.confidence}%
                            <br><strong>Code recommandé:</strong> <span class="code-display">${recommendedCode}</span>
                        `;
                        
                        if (result.subSectionAnalysis) {
                            const subAnalysis = result.subSectionAnalysis;
                            html += `
                            <div class="sub-section-info">
                                <strong>Analyse des sous-sections:</strong><br>
                                • Correspondances trouvées: ${subAnalysis.totalMatches || 0}<br>
                                • Chapitres identifiés: ${subAnalysis.chapterMatches ? subAnalysis.chapterMatches.length : 0}<br>
                                • Codes spécifiques: ${subAnalysis.specificCodes ? subAnalysis.specificCodes.length : 0}
                            </div>`;
                        }
                        
                        html += '</div>';
                    });
                } else {
                    html += '<div class="result warning">Aucune classification trouvée.</div>';
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Erreur lors de la classification: ${error.message}</div>`;
                console.error('Erreur de classification:', error);
            }
        }

        function runAllTests() {
            if (!classifier && !initializeClassifier()) {
                document.getElementById('testResults').innerHTML = '<div class="result error">Impossible d\'initialiser le classificateur.</div>';
                return;
            }
            
            testResults = [];
            let html = '<h3>Résultats des Tests</h3>';
            let successCount = 0;
            let totalTime = 0;
            
            predefinedTests.forEach((test, index) => {
                const startTime = performance.now();
                const results = classifier.classifyWithAI(test.description);
                const endTime = performance.now();
                const processingTime = endTime - startTime;
                totalTime += processingTime;
                
                const testResult = analyzeTestResult(test, results, processingTime);
                testResults.push(testResult);
                
                if (testResult.success) successCount++;
                
                const resultClass = testResult.success ? 'success' : 'error';
                html += `
                <div class="result ${resultClass}">
                    <strong>Test ${index + 1}:</strong> ${test.description}
                    <br><strong>Résultat:</strong> ${testResult.success ? 'RÉUSSI' : 'ÉCHOUÉ'}
                    <br><strong>Section attendue:</strong> ${test.expectedSection} | <strong>Obtenue:</strong> ${testResult.actualSection}
                    <br><strong>Précision attendue:</strong> ${test.expectedPrecision} | <strong>Obtenue:</strong> ${testResult.actualPrecision}
                    <br><strong>Code obtenu:</strong> <span class="code-display">${testResult.actualCode}</span>
                    <br><strong>Temps:</strong> ${processingTime.toFixed(2)}ms
                </div>`;
            });
            
            // Statistiques globales
            const successRate = ((successCount / predefinedTests.length) * 100).toFixed(1);
            const avgTime = (totalTime / predefinedTests.length).toFixed(2);
            
            html += `
            <div class="result success">
                <strong>Statistiques Globales:</strong><br>
                • Tests réussis: ${successCount}/${predefinedTests.length} (${successRate}%)<br>
                • Temps moyen: ${avgTime}ms<br>
                • Temps total: ${totalTime.toFixed(2)}ms
            </div>`;
            
            document.getElementById('testResults').innerHTML = html;
            updatePerformanceStats();
        }

        function analyzeTestResult(test, results, processingTime) {
            if (!results || results.length === 0) {
                return {
                    success: false,
                    actualSection: 'Aucune',
                    actualPrecision: 'Aucune',
                    actualCode: 'Aucun',
                    processingTime: processingTime
                };
            }
            
            const topResult = results[0];
            const actualSection = topResult.section.number;
            const actualPrecision = topResult.subSectionAnalysis ? topResult.subSectionAnalysis.precision : 'section';
            const actualCode = topResult.subSectionAnalysis && topResult.subSectionAnalysis.recommendedCode 
                ? topResult.subSectionAnalysis.recommendedCode.code 
                : 'Générique';
            
            // Vérifier le succès du test
            let success = actualSection === test.expectedSection;
            
            // Bonus si la précision correspond ou dépasse l'attendu
            const precisionLevels = { 'section': 1, 'chapitre': 2, 'sous-code': 3 };
            const expectedLevel = precisionLevels[test.expectedPrecision] || 1;
            const actualLevel = precisionLevels[actualPrecision] || 1;
            
            if (actualLevel >= expectedLevel) {
                success = success && true;
            }
            
            return {
                success: success,
                actualSection: actualSection,
                actualPrecision: actualPrecision,
                actualCode: actualCode,
                processingTime: processingTime
            };
        }

        function runSpecificTests() {
            const specificTests = predefinedTests.filter(test => test.expectedPrecision === 'sous-code');
            runCustomTests(specificTests, 'Tests des Codes Spécifiques');
        }

        function runSubCodeTests() {
            const subCodeTests = predefinedTests.filter(test => test.expectedCode && test.expectedCode.includes('.'));
            runCustomTests(subCodeTests, 'Tests des Sous-codes');
        }

        function runCustomTests(tests, title) {
            if (!classifier && !initializeClassifier()) {
                document.getElementById('testResults').innerHTML = '<div class="result error">Impossible d\'initialiser le classificateur.</div>';
                return;
            }
            
            let html = `<h3>${title}</h3>`;
            let successCount = 0;
            
            tests.forEach((test, index) => {
                const results = classifier.classifyWithAI(test.description);
                const testResult = analyzeTestResult(test, results, 0);
                
                if (testResult.success) successCount++;
                
                const resultClass = testResult.success ? 'success' : 'warning';
                html += `
                <div class="result ${resultClass}">
                    <strong>${test.description}</strong><br>
                    Section: ${testResult.actualSection} | Précision: ${testResult.actualPrecision}<br>
                    Code: <span class="code-display">${testResult.actualCode}</span>
                </div>`;
            });
            
            const successRate = ((successCount / tests.length) * 100).toFixed(1);
            html += `<div class="result success">Taux de réussite: ${successRate}%</div>`;
            
            document.getElementById('testResults').innerHTML = html;
        }

        function updatePerformanceStats() {
            if (testResults.length === 0) return;
            
            const precisionCounts = {
                'section': 0,
                'chapitre': 0,
                'sous-code': 0
            };
            
            testResults.forEach(result => {
                if (precisionCounts.hasOwnProperty(result.actualPrecision)) {
                    precisionCounts[result.actualPrecision]++;
                }
            });
            
            const avgTime = testResults.reduce((sum, result) => sum + result.processingTime, 0) / testResults.length;
            
            const html = `
            <div class="results-grid">
                <div>
                    <h4>Niveaux de Précision Atteints</h4>
                    <div>Section uniquement: ${precisionCounts.section}</div>
                    <div>Niveau chapitre: ${precisionCounts.chapitre}</div>
                    <div>Niveau sous-code: ${precisionCounts['sous-code']}</div>
                </div>
                <div>
                    <h4>Performance</h4>
                    <div>Temps moyen: ${avgTime.toFixed(2)}ms</div>
                    <div>Tests effectués: ${testResults.length}</div>
                    <div>Réussite globale: ${((testResults.filter(r => r.success).length / testResults.length) * 100).toFixed(1)}%</div>
                </div>
            </div>`;
            
            document.getElementById('performanceStats').innerHTML = html;
        }

        // Initialisation automatique
        window.addEventListener('load', () => {
            initializeClassifier();
        });
    </script>
</body>
</html>
